{% extends "legacy/1_LegacyBase.html" %}

{% block title %}Channel Management{% endblock %}

{% block content %}
	<!-- Global status visible to all users -->
	<div class="settings-header">
		<p>Channel download/update status:</p>
	</div>
	<div class="settings-panel">
		<div id="global-update-status">Idle</div>
	</div>
	
	<!-- Channel Download Interface -->
	<div class="settings-header">
		<p>Download Channel</p>
	</div>
	<div class="settings-panel">
		<form id="download-form" class="channel-url-bar">
			<input type="url" id="channel-url" name="channel_url" placeholder="Enter YouTube Channel URL" required>
      
      <!-- New check boxes for Shorts and Streams -->
      <label>
        <input type="checkbox" id="shorts-checkbox" name="include_shorts">
        Shorts
      </label>
      <label>
        <input type="checkbox" id="streams-checkbox" name="include_streams">
        Streams
      </label>
      
			<button type="submit" class="settings-page-apply-button">Download</button>
		</form>
	</div>

	<!-- Update Selected and Update All -->
	<div class="settings-header">
		<p>Update Channels</p>
	</div>
	<div class="settings-panel">
		<p>Select all the channels you want to update with new videos then press Update Selected. You can also update all channels by pressing Update All.</p>
		<div id="channel-list" class="update-channel-box">
			{% for channel in channels %}
				<div class="update-channel-item">
					<input type="checkbox" class="update-channel-checkbox" data-url="{{ channel.channel_URL }}" data-uploader="{{ channel.uploader }}">
					<span class="update-channel-uploader"> Channel: {{ channel.uploader }}</span> 
					<span class="update-channel-last_checked">Last checked: {{ channel.last_checked }}</span>
				</div>
			{% endfor %}
		</div>
		<br>
			<button id="update-selected" class="settings-page-apply-button">Update Selected</button>
			<button id="update-all" class="settings-page-apply-button">Update All</button>
	</div>
  

  <script type="text/javascript">
    // Helper function to send POST requests with XMLHttpRequest (ES5 compatible)
    function postJSON(url, data, callback, errCallback) {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              var response = JSON.parse(xhr.responseText);
              callback(response);
            } catch (e) {
              errCallback(e);
            }
          } else {
            var errorMessage = "HTTP status " + xhr.status;
            try {
              var response = JSON.parse(xhr.responseText);
              if (response && response.error) {
                errorMessage = response.error;
              }
            } catch (e) {}
            errCallback(new Error(errorMessage));
          }
        }
      };
      xhr.send(JSON.stringify(data));
    }
    
    // Helper function for GET requests
    function getJSON(url, callback, errCallback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              var response = JSON.parse(xhr.responseText);
              callback(response);
            } catch (e) {
              errCallback(e);
            }
          } else {
            errCallback(new Error("HTTP status " + xhr.status));
          }
        }
      };
      xhr.send();
    }
    
    // Poll update status every 2 seconds and format the message accordingly.
    function pollUpdateStatus() {
      getJSON('/update_status', function(data) {
        var statusDiv = document.getElementById('global-update-status');
        var text = "Status: ";
        if (data.in_progress) {
          if (data.type === "download") {
            text += "Downloading channel from link: " + data.current_channel;
          } else if (data.type === "update_channels") {
            text += "Updating Channel: " + data.current_uploader + " " + data.completed + "/" + data.total;
          } else {
            text += "In progress (" + data.type + ") " + data.progress;
          }
        } else {
          text += "Idle";
        }
        statusDiv.innerText = text;
      }, function(err) {
        // Optionally log error
      });
      setTimeout(pollUpdateStatus, 2000);
    }
    pollUpdateStatus();
    
    // Single channel download form handler
    var downloadForm = document.getElementById('download-form');
    if (downloadForm.addEventListener) {
      downloadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var url = document.getElementById('channel-url').value;
        var includeShorts = document.getElementById('shorts-checkbox').checked;
        var includeStreams = document.getElementById('streams-checkbox').checked;
        
        postJSON('/download_channel', { 
          channel_url: url,
          include_shorts: includeShorts,
          include_streams: includeStreams
        },
          function(data) {
            if (!data.success) {
              alert('Download failed: ' + data.error);
            }
          },
          function(error) {
            alert('Error: ' + error.message);
          }
        );
      }, false);
    } else if (downloadForm.attachEvent) {
      downloadForm.attachEvent('onsubmit', function(e) {
        e = e || window.event;
        e.returnValue = false;
        var url = document.getElementById('channel-url').value;
        var includeShorts = document.getElementById('shorts-checkbox').checked;
        var includeStreams = document.getElementById('streams-checkbox').checked;
        
        postJSON('/download_channel', { 
          channel_url: url,
          include_shorts: includeShorts,
          include_streams: includeStreams
        },
          function(data) {
            if (!data.success) {
              alert('Download failed: ' + data.error);
            }
          },
          function(error) {
            alert('Error: ' + error.message);
          }
        );
      });
    }
    
    // Handler for updating selected channels: build an array of objects with channel_url and uploader.
    var updateSelectedButton = document.getElementById('update-selected');
    if (updateSelectedButton.addEventListener) {
      updateSelectedButton.addEventListener('click', updateSelectedChannels, false);
    } else if (updateSelectedButton.attachEvent) {
      updateSelectedButton.attachEvent('onclick', updateSelectedChannels);
    }
    
    function updateSelectedChannels() {
      var checkboxes = document.getElementsByClassName('update-channel-checkbox');
      var channelsData = [];
      for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) {
          channelsData.push({
            channel_url: checkboxes[i].getAttribute('data-url'),
            uploader: checkboxes[i].getAttribute('data-uploader')
          });
        }
      }
      if (channelsData.length === 0) {
        alert('Please select at least one channel to update.');
        return;
      }
      postJSON('/update_selected_channels', { channels: channelsData },
        function(data) {
          if (data.success) {
            alert(data.message);
          } else {
            alert('Update failed: ' + data.error);
          }
        },
        function(error) {
          alert('Error: ' + error.message);
        }
      );
    }
    
    // Handler for updating all channels
    var updateAllButton = document.getElementById('update-all');
    if (updateAllButton.addEventListener) {
      updateAllButton.addEventListener('click', updateAllChannels, false);
    } else if (updateAllButton.attachEvent) {
      updateAllButton.attachEvent('onclick', updateAllChannels);
    }
    
    function updateAllChannels() {
      postJSON('/update_all_channels', {},
        function(data) {
          if (data.success) {
            alert(data.message);
          } else {
            alert('Update failed: ' + data.error);
          }
        },
        function(error) {
          alert('Error: ' + error.message);
        }
      );
    }
  </script>
{% endblock %}
